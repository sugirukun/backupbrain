---
tags:
  - プログラミング
---
# Difyで領収書を自動で解析＆勘定科目を仕分けしスプレッドシートにアップするチャットフロー作ってみた｜さるぼぼ | AIコンサル
#AI 
作成日: 2025/02/26
URL: https://note.com/bobosan_27/n/na3b6864df9f3

![](https://assets.st-note.com/production/uploads/images/175118307/rectangle_large_type_2_511d7067868ee3f540d8b5c8e4ba01ec.png?width=1200)

## はじめに

Difyはプログラミングの知識が不要なノーコードツールで、AIを活用したワークフローやチャットボットを誰でも簡単に作成できます。直感的な操作により、さまざまなAI機能を取り入れたアプリケーションを手軽に構築することが可能です。

本記事では、Difyを学習中の方向けに、具体例なチャットフローの例を交えて解説します。この記事を読むことで、Difyの全体像をざっくり理解できると思います。

今回のチャットフローは1時間くらいでちゃちゃっと作ったので、最適化されてなかったり、無駄・冗長な処理が結構ありますがご了承ください！

### 対象読者

- Difyについて学んでみたい！というDify初心者の方
- Difyで何ができるのか、ざっくり知りたい方
- Difyでチャットフロー勉強中の方

### この記事でわかること

- Difyの基本的な操作方法全般
    - 特に今回は会話変数,
- Difyで領収書を自動で仕分けするチャットフローの作り方
- Difyでインタラクティブなチャットフローの作り方

## 完成物のイメージ

1. 領収書の画像をアップロード
2. LLM(今回はgpt-4o-mini)で領収書に書かれた内容を取得
    1. もし読み取り精度が低い場合はユーザーへ確認を入れる
3. LLMで勘定科目をユーザーへサジェスト
4. ユーザーが選択した勘定科目でGoogleスプレッドシートへ保存

※学習のためにDSLファイルがほしい方は、下記のツイートをリポスト＆いいねしてDM頂ければ配布します！

【Difyで領収書自動仕訳】
Difyで「領収書読み取り→自動仕訳→スプシ記載」のワークフローを作りました！

精度に応じてBOTから確認が入ったり、仕訳のサジェストもしてくれます！

需要ありそうだったら、Note書いてDSL共有しますので、いいね＆リポストで応援お願いします！ [pic.twitter.com/SZK7jFNUaz](https://t.co/SZK7jFNUaz)— さるぼぼ | AIコンサル (@sarubobo_ai) [February 12, 2025](https://twitter.com/sarubobo_ai/status/1889640793570234589?ref_src=twsrc%5Etfw)

**画像での完成物のイメージ**

領収書アップロード後(内容確認フェーズ)

![](https://assets.st-note.com/img/1739797438-pNRiXV3f7soeLE0FHIO6AzB2.png)

勘定科目選択フェーズ

![](https://assets.st-note.com/img/1739797453-9n2VSFroNm7zt340pwHKUlqL.png)

勘定科目選択後(登録完了フェーズ)

![](https://assets.st-note.com/img/1739797476-3FecvGxBfPIaNk5gtRhqH6Ms.png)

## チャットフローの全体図

![](https://assets.st-note.com/img/1739794742-iDnXV5CI830GouBgPtyrJSdM.png?width=1200)

### 各ブロックの説明

**①チャットフローの開始**

このブロックでは入力に画像(今回は領収書の画像)を受け取るために入力フィールドを設定します。

![](https://assets.st-note.com/img/1739794918-Ch7pq6VvAFdM039Y8uRQfny1.png?width=1200)

**②条件に応じてチャットフローの分岐**

チャットフローを会話変数に登録した”state”を用いて分岐します。簡単にですが、各stateが何を示しているのかを自然言語で表現するのであれば、

- stateが1の場合は「領収書の精度が既に確認済み」かつ「ユーザーが勘定科目を設定した場合」です。これは後ほどのフローで出てきます
- stateが2の場合は「領収書の精度が悪い可能性がある場合」です。これも後ほどのフローで出てきます

![](https://assets.st-note.com/img/1739795257-y39PhZGfY6wsgnl17jVbELq2.png?width=1200)

後ほどのStepに繋がりますが、stateが1の場合は、既に領収書の読み取り精度やユーザーが勘定科目を指定しているため、スプレッドシートへ書き込む処理へ遷移します。

stateが2の場合は、領収書の読み取り精度が正しい可能性があるためユーザーへ内容の確認をする処理へ遷移します。

**③LLMで領収書読み取り＆勘定科目の取得**

①でアップロードした画像をInputとしてLLMで領収書に記載された内容を出力します。この時出力フォーマットはJSONで4つの項目とconfidence(読み取り精度に対する自信)と共に出力してます。

![](https://assets.st-note.com/img/1739795859-HYdjDznEoU1Ca5XL9G3087K6.png?width=1200)

その後それぞれ、出力フォーマットを整形し、会話変数にそれぞれ代入しています。ここで会話変数に代入する理由としては、後ほどチャットBotからの応答で使いやすい形に変換しておき、いつでも呼び出せるようにしておくためです。特に次のチャットに移った時など(上のstateが1や2の場合)は、再度この会話変数を使用するためとても便利です。

**④Confidenceに応じて条件分岐**

LLMが読み取った領収書のconfidenceが高い場合は、ユーザーの確認をせずにユーザーに勘定科目の選択をさせます。

一方、読み取った領収書のconfidenceが低い場合は、ユーザーへ内容の確認を依頼させます。

![](https://assets.st-note.com/img/1739796395-VoUBKyG5aMlimswqguRb2SF0.png?width=1200)

**④-①confidenceが低かった場合**confidenceが低かった場合は、**stateを「2」に変更し**、チャットボットで「はい」「いいえ」の選択をユーザーへ促します。

![](https://assets.st-note.com/img/1739796618-oFBfRhlPs7zwmGneYLNHSMU5.png)

ユーザーが「はい」か「いいえ」のボタンを押すとこんな感じで再度チャットフローが実行されます。ポイントはstateが「2」なので先ほどの分岐先とは異なります。

「はい」を選択した場合は、「領収書の内容が正しかった」と言うことなので、勘定科目を選択するフローへ分岐します。「いいえ」を選択した場合は終了します。(本当はどの項目が正しくなかったか、どう修正すれば良いか、まで実装したかったのですが、割愛しました。）

![](https://assets.st-note.com/img/1739796868-CjpLlO25zFe1dIuEy9bmH8fh.png?width=1200)

**④-②confidenceが高かった場合**

confidenceが高かった場合、もしくは、④-①で「はい」が選択された場合は、**stateを「1」に変更し**、ユーザーへ勘定科目を選んでもらいます。

![](https://assets.st-note.com/img/1739797072-PWyCTqHa0onU57vuVxlMRXBr.png)

**⑤スプレッドシートへ登録**

この分岐はstateが「2」で既にユーザーが勘定科目を選択した際に実行されます。

ですので最後は、スプレッドシートのAPIを呼び出すためにJSONペイロードを作成しAPIを呼び出します。

その後、会話変数のリセットを行います。

![](https://assets.st-note.com/img/1739797195-5wliUXf6A3cm1sTW9qxONV7g.png?width=1200)

ちなみに勘定科目を選択した後はこんな感じです。

![](https://assets.st-note.com/img/1739797335-TkomxD8eP4WMbRn0FhLzgqlc.png)

## 最後に

最後までご覧いただきありがとうございました！

私たちは日々AIに関するプロダクトを開発しております。現在、期間限定で✅**無料で相談＆AIプロダクトの導入支援✅**を承っております。

もしご興味ある方いらっしゃいましたら、下記よりご連絡いただければ幸いです！気軽にご連絡ください。

[https://forms.gle/ZhdYea7iwWQpxAJ5A](https://forms.gle/ZhdYea7iwWQpxAJ5A)

## いいなと思ったら応援しよう！